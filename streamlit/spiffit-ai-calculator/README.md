# ğŸ¤– Spiffit Multi-Agent

Intelligent SPIFF analysis powered by multiple AI agents and Databricks Genie spaces.

## ğŸ¯ Overview

A **multi-agent AI system** that intelligently routes questions across:
- ğŸ§  **3 specialized Genie spaces** (Sales, Analytics, Market Intelligence)
- ğŸŒ **Web search** for competitor intelligence
- ğŸ¤– **Foundation Models** for synthesis and reasoning

**Key Innovation:** Smart routing with graceful fallbacks ensures queries succeed even if individual agents fail.

---

## âœ¨ Features

### ğŸ§  Intelligence Tab
- **Single unified interface** for all queries
- **Smart routing** automatically selects best agents
- **Real-time visibility** of which Genies were called
- **Multi-source synthesis** combines data from multiple agents
- **Clickable examples** in sidebar for instant testing

### ğŸ“ Architecture & Tech Stack Tab
- **System architecture diagram** showing multi-agent flow
- **Databricks components** used (Genie, Foundation Models, Unity Catalog, etc.)
- **Model details** (Llama 3.1 70B, GPT-5.1, etc.)
- **Genie space status** showing which spaces are connected
- **Complete tech stack** reference table
- **Guide to verify Genie calls** in Databricks UI

### ğŸ”§ Troubleshooting Tab
- **Environment variable inspection**
- **Authentication logs** showing which method is used
- **Genie connection testing** with detailed errors
- **Deployment version tracking**
- **Live log viewer** for debugging

---

## ğŸ“ Project Structure

```
streamlit/spiffit-ai-calculator/
â”œâ”€â”€ app.py                    # Main Streamlit app (v2.0.0)
â”œâ”€â”€ ai_helper.py              # Genie & Foundation Model integration
â”œâ”€â”€ query_parser.py           # NLP query parsing
â”œâ”€â”€ multi_tool_agent.py       # Smart routing orchestrator
â”œâ”€â”€ web_search_tool.py        # Competitor intelligence
â”œâ”€â”€ spiff_agent.py            # Autonomous SPIFF agent
â”œâ”€â”€ app.yaml                  # Databricks App config
â”œâ”€â”€ requirements.txt          # Python dependencies
â”œâ”€â”€ env.example               # Local env template
â”œâ”€â”€ CHANGELOG.md              # Version history
â””â”€â”€ README.md                 # This file
```

---

## ğŸš€ Deployment

### â­ RECOMMENDED: Databricks Apps

```bash
# 1. Push to GitHub
git add .
git commit -m "Deploy Spiffit Multi-Agent v2.0"
git push origin spiffit-dev

# 2. In Databricks: https://dbc-4a93b454-f17b.cloud.databricks.com
#    - Go to Apps
#    - Find: spiffit-mocking-bird
#    - Stop & Start (auto-pulls latest from Git)
```

**Or use the deployment script:**
```powershell
# PowerShell
.\deploy-to-databricks.ps1 -AppName "spiffit-mocking-bird" -RepoId 2748186069098876

# Bash
./deploy-to-databricks.sh spiffit-mocking-bird 2748186069098876
```

**Why Databricks Apps?**
- âœ… Automatic authentication
- âœ… All Genie spaces pre-configured
- âœ… PAT token securely stored in Secrets
- âœ… Share with team via URL
- âœ… Production-ready hosting

---

## ğŸ”§ Configuration

### âœ… Genie Spaces Already Configured!

Your Genie spaces are set up in `app.yaml`:

| Space | Name | ID |
|-------|------|-----|
| **Sales** | `spg-mocking-bird-sales` | `01f0c403c3cf184e9b7f1f6c9ee45905` |
| **Analytics** | `spg-mocking-bird-analytics` | `01f0c404048613b3b494b1a64a1bca84` |
| **Market** | `spg-mocking-bird-market` | `01f0c4043acf19dc936c37fd2a8bced3` |

### ğŸ”’ PAT Token Authentication

For Genie access, the app uses PAT token authentication stored in Databricks Secrets:

- **Secret Scope:** `spiffit-secrets`
- **Secret Key:** `databricks-pat-token`
- **How to update:** See `GENIE_PAT_TOKEN_SETUP.md`

---

## ğŸ¯ Example Queries

### ğŸ” Single Agent (One Genie):
- "Show me the top performers this quarter"
- "Who won the last SPIFF competition?"

### ğŸ¤– Multi-Agent (Multiple Genies + Routing):
- "Compare our top performers with AT&T's SPIFF programs"
- "Based on our sales data and competitor intel, what SPIFFs should we offer next month?"
- "How do our incentives compare to Verizon and T-Mobile?"

### ğŸ§  Smart Routing (AI chooses best sources):
- "Should we increase our SPIFF budget? Consider sales performance, leaderboards, and what competitors are doing."

ğŸ’¡ **Pro Tip:** Click any example in the sidebar to instantly test it!

---

## ğŸ” Verify Genie Calls in Databricks

### Method 1: In the App
- Look for **"ğŸ§  Genies Called: Sales, Analytics, Market"** after each response
- Expand **"ğŸ§  AI Reasoning & Smart Routing"** for full details

### Method 2: In Databricks UI
1. Go to **SQL** â†’ **SQL Warehouses** â†’ `hackaithon_Spiffit_serverless`
2. Click **Query History** tab
3. Filter by **Last hour**
4. See all SQL queries generated by Genie

### Method 3: Genie Conversation History
1. Go to **Genie** in Databricks
2. Click on each Genie space
3. View **Conversation History**

---

## ğŸ†˜ Troubleshooting

### âŒ Genie Connection Errors?

**1. Check Authentication:**
- Go to **ğŸ”§ Troubleshooting** tab
- Look for: `Auth Method: PAT Token`
- If it says `OAuth M2M`, the PAT token isn't loading

**2. Verify Genie Permissions:**
- Each Genie space needs **"Can Run"** permissions for your user
- Go to Genie â†’ click space â†’ Settings â†’ Permissions

**3. Check SQL Warehouse:**
- Go to **SQL** â†’ **SQL Warehouses**
- Start: `hackaithon_Spiffit_serverless`

**4. View Logs:**
- Go to **ğŸ”§ Troubleshooting** tab
- Scroll to **"ğŸ“œ Authentication & API Logs"**
- Look for errors

### ğŸ”„ App Not Updating?

```powershell
# Re-deploy manually
.\deploy-to-databricks.ps1 -AppName "spiffit-mocking-bird"
```

### ğŸ› Still Having Issues?

- Check `GENIE_PERMISSIONS_FIX.md`
- Check `GENIE_PAT_TOKEN_SETUP.md`
- View logs in **ğŸ”§ Troubleshooting** tab

---

## ğŸ“š Documentation

### Core Docs:
- **Architecture Guide:** Check the **ğŸ“ Architecture & Tech Stack** tab in the app!
- **Multi-Genie Workflows:** `../../docs/MULTI_GENIE_WORKFLOWS.md`
- **Smart Routing:** `../../docs/SMART_GENIE_ROUTING.md`
- **Autonomous Agent:** `../../docs/AUTONOMOUS_SPIFF_AGENT.md`

### Setup Guides:
- **Databricks Deployment:** `DEPLOY_TO_DATABRICKS.md`
- **Genie Setup:** `../../docs/GENIE_SETUP.md`
- **PAT Token Setup:** `GENIE_PAT_TOKEN_SETUP.md`
- **Permissions Fix:** `GENIE_PERMISSIONS_FIX.md`

### Developer Guides:
- **AI Integration:** `../../docs/ai_integration_guide.md`
- **Creating Genie Spaces:** `../../docs/CREATE_GENIE_SPACES_GUIDE.md`
- **Deployment Scripts:** `../../DEPLOYMENT_SCRIPTS.md`

---

## ğŸ‰ Version History

**v2.0.0-DEMO** (Current)
- âœ… Simplified UI: Single Intelligence tab
- âœ… Clickable examples in sidebar
- âœ… New Architecture & Tech Stack tab
- âœ… Real-time Genie call visibility
- âœ… Smart routing with multi-source synthesis

**v1.4.7-DEMO**
- Fixed authentication conflicts (PAT vs OAuth)
- Added comprehensive logging

**v1.3.0**
- Added Competitor Intelligence tab
- Multi-tool agent with smart routing

See `CHANGELOG.md` for full history.

---

## ğŸ¤ Contributing

This is a hackathon demo app. For questions or contributions:

1. **Git Repo:** `github.com/stargazermi/spiffit`
2. **Branch:** `spiffit-dev`
3. **Databricks Workspace:** `dlk-hackathon`

**Good luck! ğŸš€**
